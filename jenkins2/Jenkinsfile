pipeline {

agent any

environment {
  registry = "https://hub.docker.com/"
  dockercredentials = "docker-cred"  
  dockerimage = "salahabbasi/centos:$BUILD_NUMBER"
  TRIVY_REPORT = "trivy-report.json"
  SONAR_HOME = tool "sonar-scanner"
  SONAR_CRED = credentials('sonar-token')
}

stages {
 stage ('get branch') {
   steps {
		echo 'working branch is ' + "$GIT_BRANCH"
   }
 
 }

stage ('Sonarcheck') {
steps {
   withSonarQubeEnv("sonar-server") {
	println "${env.SONAR_HOST_URL}, ${env.SONAR_CONFIG_NAME}"
	sh "${SONAR_HOME}/bin/sonar-scanner -Dsonar.projectname=ci-cd--2 -Dsonar.projectkey=ci-cd--2 -Dsonar.login=$SONAR_CRED"
  }
	
}
	
}
 
 stage ('build image') {
 steps {
	echo 'building image'
	script  {
	sh ( script: '''
	    docker images -a
     	    cd docker
     	    docker build -t ${dockerimage} .
	    docker images -a 
	''')
	
	
	}
 
 }
 }
 
//stage ('Scan image') {
 //steps {
//	echo 'Scanning the image'
//	sh ( script: '''
//	trivy image --severity HIGH,CRITICAL -f json -o report.json salahabbasi/centos:2
//	''')
//	 
// }
	
}
 

}
