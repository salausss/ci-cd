pipeline {

agent any

environment {
  registry = "https://hub.docker.com/"
  dockercredentials = "docker-cred"  
  dockerimage = "salahabbasi/centos:$BUILD_NUMBER"
  TRIVY_REPORT = "trivy-report.json"
}

stages {
 stage ('get branch') {
   steps {
		echo 'working branch is ' + "$GIT_BRANCH"
   }
 
 }
 
 stage ('build image') {
 steps {
	echo 'building image'
	script  {
	sh ( script: '''
	    docker images -a
     	    cd docker
     	    docker build -t ${dockerimage} .
	    docker images -a 
	''')
	
	
	}
 
 }
 }
 
 stage ('Scanning image') {
 steps {
   echo 'starting the image scanning'
 script {
   sh ( script: '''
 def trivyOutput = sh(script: "trivy image ${dockerimage}", returnStdout: true).trim()

 println trivyOutput

 if (trivyOutput.contains("Total: 0")) {
	echo "No vuln found"
  } else {
	echo "Vuln found further configuration needed"
  }
 
 ## trivy image --exit-code 1 --severity HIGH,CRITICAL --format json  ${dockerimage} > ${TRIVY_REPORT}
	''')
 }  
 
 }
 
 }
 

}


}
